<!DOCTYPE html>
<html>
<head>
  <title>Miniprogram JSAPI Demo</title>
  <script src="https://cdn.jsdelivr.net/gh/Buddhima-JD3/mini-bridge@master/index.js"></script>
</head>
<body>
  <div>
    <button id="alert" onclick="setupMyButton();">alert</button>
  </div>
  <script>
    var minidata;
    document.addEventListener('DOMContentLoaded', function() {
  if (window.my && typeof my.initiate === 'function') {
    my.initiate({
      'AuthCode': {
        success: function(data) {
          console.log('AuthCode received:', data);
          // Dispatch custom event for success
          document.dispatchEvent(new CustomEvent('authCodeSuccess', { detail: data }));
        },
        fail: function(err) {
          console.error('Auth Code Sync Error:', err);
          // Dispatch custom event for failure
          document.dispatchEvent(new CustomEvent('authCodeFailure', { detail: err }));
        }
      },
      'UserConsentData': {
        success: function(data) {
          console.log('UserConsentData received:', data);
          // Dispatch custom event for success
          document.dispatchEvent(new CustomEvent('userConsentDataSuccess', { detail: data }));
        },
        fail: function(err) {
          console.error('User Consent Data Sync Error:', err);
          // Dispatch custom event for failure
          document.dispatchEvent(new CustomEvent('userConsentDataFailure', { detail: err }));
        }
      },
      'TradePayData': {
        success: function(data) {
          console.log('TradePayData received:', data);
          // Dispatch custom event for success
          document.dispatchEvent(new CustomEvent('tradePayDataSuccess', { detail: data }));
        },
        fail: function(err) {
          console.error('Trade Pay Data Sync Error:', err);
          // Dispatch custom event for failure
          document.dispatchEvent(new CustomEvent('tradePayDataFailure', { detail: err }));
        }
      }
    });
  }


      // Simulate Angular route query params subscription
      // Check for 'code' query parameter in the URL
      if (!new URLSearchParams(window.location.search).has('code')) {
        console.log('Invoke SDK');
        const data = {
          clientId:  'mini-app', // Replace with your clientId
          redirectUrl: 'https://buddhima-jd3.github.io/hylid-bridge/'// Replace with your redirectUrl
        };
        // Ensure my.getMyAuthCode is a function before calling
        if (window.my && typeof my.getMyAuthCode === 'function') {
          my.getAuthCode(JSON.stringify(data));
        }
      }

    });

    function setupMyButton() {
      var alertButton = document.getElementById('alert');
      alertButton.addEventListener('click', function() {
        const data = { clientId: 'mini-app', redirectUrl: 'https://buddhima-jd3.github.io/hylid-bridge/' };
        // Ensure my.getMyAuthCode is a function before calling
        if (window.my && typeof my.getMyAuthCode === 'function') {
          my.getAuthCode(JSON.stringify(data));
        }
      });
    }
  </script>
</body>
</html>
